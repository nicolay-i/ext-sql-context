# Техническое описание: SQL Context Extension для VS Code

## 1. Краткий обзор архитектуры

**SQL Context** - это расширение для VS Code, которое позволяет генерировать контекст базы данных в виде Markdown-файла на основе настроек подключения к различным СУБД. Расширение поддерживает работу с PostgreSQL, MySQL и SQLite.

**Ключевые архитектурные решения:**
- **Монолитная архитектура** - вся логика расширения содержится в одном пакете
- **Модульная структура** - функциональность разделена на независимые модули с чёткими зонами ответственности
- **Интеграция с VS Code API** - использование секретного хранилища, команд, WebView и других возможностей редактора
- **Безопасное хранение данных** - конфигурации подключений хранятся в зашифрованном хранилище VS Code

## 2. Структура проекта

```
src/
├── connectionManager.ts   # Управление подключениями к БД
├── contextGenerator.ts    # Генерация схемы БД и Markdown-документации
├── envUtils.ts           # Утилиты для работы с .env файлами
├── extension.ts          # Точка входа расширения, регистрация команд
├── settingsWebview.ts    # Логика WebView для настроек подключения
└── types.ts              # Определение типов TypeScript

media/
└── settings.html         # WebView UI для настроек подключения
```

### Описание основных директорий и файлов:

- **`src/connectionManager.ts`**: 
  - Управляет сохранением, загрузкой и удалением конфигураций подключений
  - Использует секретное хранилище VS Code (`context.secrets`)
  - Реализует кэширование конфигураций в памяти
  - Поддерживает импорт/экспорт настроек из .env файлов

- **`src/contextGenerator.ts`**:
  - Содержит логику подключения к различным СУБД (PostgreSQL, MySQL, SQLite)
  - Извлекает схему базы данных (таблицы, колонки, типы данных)
  - Генерирует Markdown-документацию на основе схемы
  - Включает функцию тестирования соединения с БД

- **`src/envUtils.ts`**:
  - Преобразует конфигурации подключения в .env формат и обратно
  - Парсит содержимое .env файлов
  - Обрабатывает различные форматы переменных окружения для разных СУБД

- **`src/extension.ts`**:
  - Точка входа расширения
  - Регистрирует команды VS Code
  - Реализует обработчики пользовательских действий
  - Управляет взаимодействием между модулями

- **`src/settingsWebview.ts`**:
  - Управляет WebView интерфейсом для настроек подключения
  - Обрабатывает сообщения между WebView и основной частью расширения
  - Реализует сохранение и загрузку настроек генерации

- **`src/types.ts`**:
  - Определяет все типы данных, используемые в проекте
  - Описывает структуру конфигурации подключения, схемы БД и т.д.

- **`media/settings.html`**:
  - WebView интерфейс для настройки подключений
  - Содержит HTML-разметку, CSS-стили и JavaScript-логику UI
  - Реализует вкладки для управления подключениями и настройками генерации

## 3. Описание ключевых модулей и их взаимодействия

### ConnectionManager
- **Зона ответственности**: управление конфигурациями подключений
- **Ключевые методы**:
  - `getConnection()` - получение конфигурации для рабочей папки
  - `saveConnection()` - сохранение конфигурации
  - `removeConnection()` - удаление конфигурации
  - `importFromEnv()` - импорт настроек из .env
  - `exportToEnv()` - экспорт настроек в .env формат
- **Взаимодействие**:
  - Используется в `extension.ts` для получения конфигурации
  - Используется в `settingsWebview.ts` для сохранения/загрузки настроек
  - Хранит данные в секретном хранилище VS Code

### DatabaseContextGenerator
- **Зона ответственности**: генерация схемы БД и Markdown-документации
- **Ключевые методы**:
  - `loadSchema()` - загрузка схемы БД
  - `generateMarkdown()` - генерация Markdown-документа
  - `testConnection()` - проверка соединения с БД
- **Взаимодействие**:
  - Используется в `extension.ts` для генерации контекста
  - Используется в `settingsWebview.ts` для тестирования соединения
  - Работает с конфигурацией из `ConnectionManager`

### SettingsWebview
- **Зона ответственности**: UI для настройки подключений
- **Ключевые функции**:
  - Отображение интерфейса настроек
  - Обработка пользовательского ввода
  - Отправка сообщений в основную часть расширения
- **Взаимодействие**:
  - Связан с `settings.html` через сообщения
  - Использует `ConnectionManager` для работы с конфигурациями
  - Получает данные из `envUtils` для импорта/экспорта

### Extension
- **Зона ответственности**: точка входа и координатор
- **Ключевые команды**:
  - `sql-context.openSettings` - открытие настроек
  - `sql-context.generateContext` - генерация контекста
  - `sql-context.importConnectionFromEnv` - импорт из .env
  - `sql-context.exportConnectionToEnv` - экспорт в .env
- **Взаимодействие**:
  - Инициализирует `ConnectionManager` и `SettingsWebview`
  - Координирует работу между модулями
  - Регистрирует команды в VS Code

## 4. Поток данных в приложении

1. **Поток при настройке подключения:**
   ```
   UI (WebView) → SettingsWebview → ConnectionManager → VS Code Secret Storage
   ```

2. **Поток при генерации контекста:**
   ```
   Команда VS Code → Extension → ConnectionManager (получение конфигурации) 
   → DatabaseContextGenerator (подключение к БД и генерация схемы) 
   → Файловая система (сохранение Markdown)
   ```

3. **Поток при импорте/экспорте .env:**
   ```
   Команда VS Code → Extension → ConnectionManager → EnvUtils → UI/Clipboard
   ```

4. **Поток в WebView интерфейсе:**
   ```
   WebView UI → JavaScript → settingsWebview.ts (через postMessage) 
   → Обработка в расширении → Ответ в WebView (через postMessage)
   ```

## 5. Руководство для разработчика

### Где искать код для X?

- **Настройки подключения:** `src/settingsWebview.ts` и `media/settings.html`
- **Логика работы с БД:** `src/contextGenerator.ts`
- **Управление конфигурациями:** `src/connectionManager.ts`
- **Обработка команд:** `src/extension.ts`
- **Типы данных:** `src/types.ts`
- **Работа с .env файлами:** `src/envUtils.ts`

### Как добавить новую фичу Y?

#### Добавление новой команды VS Code:
1. В `extension.ts` добавьте регистрацию команды:
   ```typescript
   context.subscriptions.push(
     vscode.commands.registerCommand('sql-context.newCommand', async () => {
       // Логика команды
     })
   );
   ```

#### Добавление поддержки новой СУБД:
1. Обновите `DatabaseProvider` в `types.ts`
2. Добавьте кейс в `loadSchema()` в `contextGenerator.ts`
3. Реализуйте методы подключения к новой СУБД
4. Добавьте опцию в select провайдера в `settings.html`
5. Обновьте логику в `settingsWebview.ts` для обработки нового провайдера

#### Изменение формата генерируемого Markdown:
1. Измените функцию `renderMarkdown()` в `contextGenerator.ts`
2. При необходимости обновите структуру `DatabaseSchema` в `types.ts`

### Как работать со стейт-менеджментом и API?

- **State Management:**
  - Конфигурации подключений хранятся в `ConnectionManager`
  - Состояние WebView управляется через сообщения между `settingsWebview.ts` и `settings.html`
  - Кэширование конфигураций реализовано через `Map` в `ConnectionManager`

- **Работа с API баз данных:**
  - Используйте `DatabaseContextGenerator` для подключения к БД
  - Для тестирования соединения вызывайте `testConnection()`
  - Для генерации схемы используйте `loadSchema()` и `generateMarkdown()`

- **Работа с секретным хранилищем:**
  - Все методы работы с секретами инкапсулированы в `ConnectionManager`
  - Для доступа к конфигурациям используйте методы `getConnection()` и `saveConnection()`

### Стили и UI

- **Изменение интерфейса WebView:**
  - HTML структура: `media/settings.html`
  - Стили находятся внутри `<style>` тега в `settings.html`
  - JavaScript для UI находится в конце `settings.html`

- **Добавление новых элементов UI:**
  1. Добавьте HTML в `settings.html`
  2. Добавьте стили в секцию `<style>`
  3. Реализуйте обработчики событий в JavaScript части
  4. При необходимости добавьте обработку сообщений в `settingsWebview.ts`

### Тестирование изменений

- **Тестирование WebView:**
  - Запустите отладку расширения (F5)
  - Откройте командную палитру (Ctrl+Shift+P)
  - Выполните команду `SQL Context: Open Settings`

- **Тестирование генерации контекста:**
  1. Настройте подключение к БД
  2. Выполните команду `SQL Context: Generate Context`
  3. Проверьте созданный Markdown файл

- **Тестирование импорта/экспорта .env:**
  1. Выполните команду `SQL Context: Export Connection to .env`
  2. Проверьте содержимое буфера обмена
  3. Измените данные и выполните импорт через `SQL Context: Import Connection from .env`

Это техническое описание должно помочь вам быстро разобраться в архитектуре проекта и начать вносить изменения. Все модули спроектированы с учётом принципа единственной ответственности, что упрощает расширение функциональности и поддержку кода.