# Техническое описание расширения SQL Context

## 1. Обзор архитектуры

SQL Context - это расширение для VS Code, которое позволяет генерировать документацию по структуре базы данных в формате Markdown. Архитектура построена по модульному принципу с использованием WebView для пользовательского интерфейса:

- **Клиент-серверная модель**: WebView (клиент) взаимодействует с бэкендом расширения через систему сообщений
- **Модульная структура**: Функциональность разделена на независимые модули с четкими зонами ответственности
- **Безопасное хранение**: Данные подключений хранятся в защищенном хранилище VS Code
- **Поддержка множественных БД**: Реализована поддержка PostgreSQL, MySQL и SQLite

## 2. Структура проекта

```
sql-context/
├── media/
│   └── settings.html          # WebView интерфейс настроек
├── src/
│   ├── connectionManager.ts   # Управление подключениями к БД
│   ├── contextGenerator.ts    # Генерация контекста БД
│   ├── envUtils.ts           # Утилиты для работы с .env файлами
│   ├── extension.ts          # Точка входа расширения
│   ├── settingsWebview.ts    # Управление WebView
│   └── types.ts              # Определение типов данных
```

### Описание основных директорий и файлов:

- **media/settings.html**: HTML-шаблон для WebView интерфейса настроек. Содержит:
  - HTML-структуру вкладок (настройки генерации, настройки подключения)
  - CSS-стили с использованием переменных VS Code для темной/светлой тем
  - JavaScript код для обработки взаимодействий пользователя
  
- **src/connectionManager.ts**: 
  - Управляет жизненным циклом подключений к БД
  - Использует `vscode.SecretStorage` для безопасного хранения конфигураций
  - Реализует импорт/экспорт конфигураций в формате .env
  
- **src/contextGenerator.ts**:
  - Содержит логику подключения к различным СУБД
  - Извлекает метаданные БД (таблицы, столбцы, внешние ключи)
  - Генерирует Markdown-документацию по схеме БД
  - Реализует функцию тестирования подключений
  
- **src/envUtils.ts**:
  - Парсит .env файлы в объекты конфигурации
  - Преобразует конфигурации подключений в .env формат
  - Обрабатывает различные форматы переменных окружения
  
- **src/extension.ts**:
  - Точка входа расширения
  - Регистрирует команды VS Code
  - Обрабатывает пользовательские действия через команды
  
- **src/settingsWebview.ts**:
  - Управляет жизненным циклом WebView
  - Обрабатывает сообщения от WebView
  - Координирует взаимодействие между WebView и другими модулями
  
- **src/types.ts**:
  - Определяет типы данных для конфигураций подключений
  - Описывает структуру схемы БД
  - Содержит интерфейсы для таблиц, столбцов и внешних ключей

## 3. Ключевые модули и их взаимодействие

### Основные модули:

1. **ConnectionManager**
   - Отвечает за хранение, получение и удаление конфигураций подключений
   - Использует безопасное хранилище VS Code для хранения чувствительных данных
   - Предоставляет методы для импорта/экспорта конфигураций

2. **DatabaseContextGenerator**
   - Устанавливает соединение с БД на основе конфигурации
   - Извлекает метаданные схемы БД
   - Генерирует Markdown-представление схемы
   - Тестирует соединения с БД

3. **SettingsWebview**
   - Создает и управляет WebView интерфейсом
   - Обрабатывает сообщения от WebView
   - Координирует действия между WebView и другими модулями

4. **EnvUtils**
   - Преобразует между форматами .env и внутренними конфигурациями
   - Поддерживает различные форматы переменных окружения

### Взаимодействие модулей:

1. **Настройка подключения**:
   ```
   WebView → SettingsWebview → ConnectionManager → Secure Storage
   ```

2. **Генерация контекста**:
   ```
   Extension → ConnectionManager → DatabaseContextGenerator → БД → Markdown
   ```

3. **Тестирование подключения**:
   ```
   WebView → SettingsWebview → DatabaseContextGenerator → БД → WebView
   ```

4. **Импорт/экспорт конфигураций**:
   ```
   WebView → SettingsWebview → EnvUtils ↔ ConnectionManager
   ```

## 4. Поток данных в приложении

1. **Инициализация WebView**:
   - Пользователь выполняет команду открытия настроек
   - `extension.ts` создает WebView через `SettingsWebview`
   - WebView загружает HTML из `settings.html`
   - WebView отправляет сообщение `ready`
   - `SettingsWebview` запрашивает текущую конфигурацию через `ConnectionManager`
   - Конфигурация отправляется в WebView для отображения

2. **Сохранение конфигурации**:
   - Пользователь изменяет настройки в WebView
   - WebView отправляет сообщение `save` с конфигурацией
   - `SettingsWebview` обрабатывает сообщение и вызывает `ConnectionManager.saveConnection`
   - Конфигурация сохраняется в защищенном хранилище
   - WebView обновляется с новой конфигурацией

3. **Генерация контекста**:
   - Пользователь запускает команду генерации
   - `extension.ts` получает конфигурацию через `ConnectionManager`
   - Создается экземпляр `DatabaseContextGenerator`
   - Выполняется подключение к БД и извлечение схемы
   - Генерируется Markdown-файл на основе шаблона пути
   - Файл сохраняется в файловой системе

4. **Тестирование подключения**:
   - Пользователь нажимает "Test Connection" в WebView
   - WebView отправляет сообщение `testConnection` с текущей конфигурацией
   - `SettingsWebview` вызывает `DatabaseContextGenerator.testConnection`
   - Результат теста отправляется обратно в WebView для отображения

## 5. Руководство для разработчика

### Где искать код для конкретных функций:

- **Настройки подключения**: 
  - WebView интерфейс: `media/settings.html` (раздел `tab-conn`)
  - Обработка на бэкенде: `src/settingsWebview.ts` (обработчики сообщений `save`, `testConnection`)
  - Хранение конфигураций: `src/connectionManager.ts`

- **Генерация контекста**:
  - Основная логика: `src/contextGenerator.ts` (методы `loadSchema`, `generateMarkdown`)
  - Запуск генерации: `src/extension.ts` (команда `sql-context.generateContext`)

- **Импорт/экспорт .env**:
  - Парсинг .env: `src/envUtils.ts` (методы `connectionFromEnv`, `connectionToEnv`)
  - WebView интерфейс: `media/settings.html` (секция `.env import`)
  - Обработка: `src/settingsWebview.ts` (обработчики `importEnv`, `exportEnv`)

- **Настройки генерации**:
  - WebView интерфейс: `media/settings.html` (раздел `tab-gen`)
  - Обработка: `src/settingsWebview.ts` (обработчик `saveGeneration`)
  - Применение шаблонов: `src/extension.ts` (функция `applyTemplate`)

### Как добавить новую функциональность:

**Пример: Добавление поддержки новой СУБД (MongoDB)**

1. **Обновить типы** (`src/types.ts`):
   ```typescript
   export type DatabaseProvider = 'mysql' | 'postgres' | 'sqlite' | 'mongodb';
   ```

2. **Расширить конфигурацию подключения** (`src/types.ts`):
   ```typescript
   export interface ConnectionConfig {
     provider: DatabaseProvider;
     // ... существующие поля
     connectionString?: string; // Для MongoDB
   }
   ```

3. **Добавить логику подключения** (`src/contextGenerator.ts`):
   ```typescript
   private async loadMongoDbSchema(): Promise<DatabaseSchema> {
     // Реализация подключения к MongoDB и извлечения схемы
   }
   
   async loadSchema(): Promise<DatabaseSchema> {
     // ... существующие case
     case 'mongodb':
       return this.loadMongoDbSchema();
   }
   ```

4. **Обновить WebView интерфейс** (`media/settings.html`):
   ```html
   <select id="provider">
     <!-- ... существующие option -->
     <option value="mongodb">MongoDB</option>
   </select>
   
   <!-- Добавить поля для MongoDB -->
   <div id="mongoFields" class="hidden">
     <label>Connection String</label>
     <input id="connectionString" type="text" />
   </div>
   ```

5. **Обновить обработку в WebView** (`media/settings.html`):
   ```javascript
   function toggleProviderFields() {
     // ... существующая логика
     const isMongo = p === 'mongodb';
     els.sqlFields.classList.toggle('hidden', isMongo || isSqlite);
     els.sqliteFields.classList.toggle('hidden', !isSqlite);
     els.mongoFields.classList.toggle('hidden', !isMongo);
   }
   ```

6. **Обновить сбор конфигурации** (`media/settings.html`):
   ```javascript
   function collectConfig() {
     // ... существующая логика
     if (provider === 'mongodb') {
       return { 
         provider: 'mongodb', 
         connectionString: els.connectionString.value 
       };
     }
   }
   ```

### Работа со стилями и UI:

- **Расположение стилей**: Все стили находятся в `media/settings.html` внутри тега `<style>`
- **Тематизация**: Используются CSS-переменные VS Code для адаптации под текущую тему:
  ```css
  body {
    color: var(--vscode-foreground);
    background: var(--vscode-editor-background);
  }
  ```
- **Добавление новых стилей**: Достаточно добавить новые CSS-правила в секцию `<style>` в `settings.html`

### Управление состоянием (State Management):

- **Конфигурации подключений**: Хранятся в `ConnectionManager` с использованием `vscode.SecretStorage`
- **Состояние WebView**: Управляется через JavaScript код в `settings.html`
  - Отслеживание несохраненных изменений: функция `updateDirty`
  - Переключение вкладок: функция `switchTab`
- **Обмен состоянием**:
  - WebView → Бэкенд: через `vscode.postMessage`
  - Бэкенд → WebView: через `panel.webview.postMessage`
- **Инициализация состояния**: При открытии WebView запрашивается текущая конфигурация через `ConnectionManager.getConnection`

### Добавление новой команды в VS Code:

1. **Зарегистрировать команду** (`src/extension.ts`):
   ```typescript
   context.subscriptions.push(
     vscode.commands.registerCommand('sql-context.myNewCommand', async () => {
       // Реализация команды
     })
   );
   ```

2. **Обновить package.json** (в корне проекта):
   ```json
   "contributes": {
     "commands": [
       {
         "command": "sql-context.myNewCommand",
         "title": "My New Command"
       }
     ]
   }
   ```

3. **Добавить обработку в WebView** (если требуется):
   ```javascript
   // В settings.html
   document.getElementById('myButton').addEventListener('click', () => {
     vscode.postMessage({ type: 'myNewAction' });
   });
   
   // В settingsWebview.ts
   case 'myNewAction':
     // Обработка действия
     break;
   ```