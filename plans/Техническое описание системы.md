# Техническое описание расширения SQL Context для VS Code

## 1. Краткий обзор архитектуры

Проект представляет собой расширение для Visual Studio Code, написанное на TypeScript. Архитектура основана на модульном подходе со следующими ключевыми компонентами:

- **Монолитная архитектура**: Весь код находится в одном расширении VS Code без разделения на микросервисы
- **Клиент-серверное взаимодействие**: Расширение выступает клиентом для различных СУБД (PostgreSQL, MySQL, SQLite)
- **Модель команд**: Основная логика активируется через команды VS Code, зарегистрированные в `extension.ts`
- **Безопасное хранение данных**: Используется `vscode.ExtensionContext.secrets` для хранения конфигураций подключений
- **UI через WebView**: Настройки подключения реализованы через WebView интерфейс

Основные компоненты системы:
- Connection Manager - управление конфигурациями подключений
- Context Generator - генерация контекста базы данных
- Settings WebView - интерфейс настройки подключений
- Env Utils - работа с .env файлами

## 2. Структура проекта

```
/
├── src/                      # Исходный код расширения
│   ├── connectionManager.ts  # Управление конфигурациями подключений
│   ├── contextGenerator.ts   # Генерация контекста БД
│   ├── envUtils.ts           # Утилиты для работы с .env файлами
│   ├── extension.ts          # Точка входа расширения
│   ├── settingsWebview.ts    # Логика WebView интерфейса
│   └── types.ts              # Определения типов TypeScript
├── media/                    # Статические ресурсы
│   └── settings.html         # HTML интерфейс настроек
└── package.json              # Манифест расширения (предполагается)
```

### Описание основных директорий и файлов:

- **src/**: Основной исходный код
  - `extension.ts`: Точка входа, регистрация команд VS Code и обработчики событий
  - `connectionManager.ts`: Класс для управления конфигурациями подключений (хранение, загрузка, удаление)
  - `contextGenerator.ts`: Класс для генерации контекста базы данных, поддержка разных СУБД
  - `envUtils.ts`: Функции преобразования между конфигурацией и .env форматом
  - `settingsWebview.ts`: Реализация WebView интерфейса для настроек
  - `types.ts`: Определение всех типов данных, используемых в проекте

- **media/**: Статические ресурсы для UI
  - `settings.html`: HTML-разметка интерфейса настроек подключения

## 3. Описание ключевых модулей и их взаимодействия

### Ключевые модули:

1. **Extension (`extension.ts`)**
   - Регистрирует команды VS Code
   - Инициализирует ConnectionManager и SettingsWebview
   - Обрабатывает пользовательские команды

2. **ConnectionManager (`connectionManager.ts`)**
   - Управляет конфигурациями подключений для каждой рабочей папки
   - Использует `vscode.ExtensionContext.secrets` для безопасного хранения
   - Предоставляет методы для CRUD операций с конфигурациями
   - Поддерживает импорт/экспорт в .env формат

3. **ContextGenerator (`contextGenerator.ts`)**
   - Подключается к различным СУБД (PostgreSQL, MySQL, SQLite)
   - Извлекает схему базы данных
   - Генерирует Markdown-представление схемы
   - Реализует специфичную логику для каждого типа СУБД

4. **SettingsWebview (`settingsWebview.ts`)**
   - Создает WebView панель для настройки подключений
   - Обрабатывает сообщения между WebView и расширением
   - Управляет состоянием интерфейса настроек

5. **EnvUtils (`envUtils.ts`)**
   - Парсит .env файлы
   - Преобразует конфигурации в .env формат и обратно
   - Определяет тип СУБД на основе переменных окружения

### Взаимодействие модулей:

1. Пользователь вызывает команду (например, `sql-context.generateContext`)
2. Extension делегирует выполнение соответствующему обработчику
3. Обработчик использует ConnectionManager для получения конфигурации
4. При наличии конфигурации создается ContextGenerator
5. ContextGenerator подключается к БД и генерирует контекст
6. Результат сохраняется в файл или отображается пользователю

При настройке подключения:
1. WebView отправляет сообщение в SettingsWebview
2. SettingsWebview вызывает методы ConnectionManager
3. ConnectionManager сохраняет данные в secrets и кэш

## 4. Поток данных в приложении

1. **Настройка подключения**:
   ```
   UI (WebView) → SettingsWebview → ConnectionManager → secrets storage
   ```

2. **Генерация контекста**:
   ```
   VS Code Command → Extension → ConnectionManager → ContextGenerator → Database → Markdown File
   ```

3. **Импорт/экспорт .env**:
   ```
   .env File/Clipboard → EnvUtils → ConnectionManager → secrets storage
   ConnectionManager → EnvUtils → .env File/Clipboard
   ```

4. **Хранение конфигураций**:
   ```
   ConnectionConfig → ConnectionManager → vscode.ExtensionContext.secrets
   ```

## 5. Руководство для разработчика

### Где искать код для X?

- **Команды расширения**: `src/extension.ts` - функции, зарегистрированные через `vscode.commands.registerCommand`
- **Логика подключения к БД**: `src/contextGenerator.ts` - методы `loadPostgresSchema`, `loadMySqlSchema`, `loadSqliteSchema`
- **Управление конфигурациями**: `src/connectionManager.ts` - методы `getConnection`, `saveConnection`, `removeConnection`
- **UI настроек**: `src/settingsWebview.ts` (логика) и `media/settings.html` (интерфейс)
- **Работа с .env**: `src/envUtils.ts` - функции `connectionFromEnv` и `connectionToEnv`
- **Типы данных**: `src/types.ts` - все интерфейсы и типы

### Как добавить новую фичу Y?

**Пример: Добавление поддержки новой СУБД (например, Oracle)**

1. **Обновить типы** в `src/types.ts`:
   ```typescript
   export type DatabaseProvider = 'mysql' | 'postgres' | 'sqlite' | 'oracle';
   
   export interface ConnectionConfig {
     provider: DatabaseProvider;
     // ... существующие поля
     serviceName?: string; // специфичное поле для Oracle
   }
   ```

2. **Реализовать загрузку схемы** в `src/contextGenerator.ts`:
   ```typescript
   private async loadOracleSchema(): Promise<DatabaseSchema> {
     // Реализация подключения к Oracle и извлечения схемы
   }
   
   async loadSchema(): Promise<DatabaseSchema> {
     // ...
     case 'oracle':
       return this.loadOracleSchema();
   }
   ```

3. **Обновить утилиты .env** в `src/envUtils.ts`:
   ```typescript
   function resolveProvider(env: Record<string, string>): DatabaseProvider {
     // ...
     if (normalized === 'oracle') {
       return 'oracle';
     }
   }
   
   export function connectionFromEnv(content: string): EnvConnectionPayload {
     // ...
     if (provider === 'oracle') {
       // Парсинг специфичных для Oracle переменных
     }
   }
   ```

4. **Обновить UI** в `media/settings.html`:
   ```html
   <select id="provider">
     <!-- Существующие опции -->
     <option value="oracle">Oracle</option>
   </select>
   ```

5. **Обновить настройки подключения** в `src/extension.ts`:
   ```typescript
   async function configureConnection(/*...*/) {
     const provider = await vscode.window.showQuickPick(/*...*/ [
       // Существующие опции
       { label: 'Oracle', value: 'oracle' }
     ]);
     
     if (provider.value === 'oracle') {
       config = await promptForOracleConnection(existing);
     }
   }
   ```

### Стили и UI

- **Стили**: Определены внутри `media/settings.html` в теге `<style>`. Используют CSS-переменные VS Code для адаптации под тему:
  ```css
  body { font-family: var(--vscode-font-family); }
  input { background: var(--vscode-input-background); }
  ```
- **UI**: Реализован через WebView. Основной файл - `media/settings.html`. Взаимодействие с TypeScript происходит через сообщения:
  ```typescript
  // В settingsWebview.ts
  panel.webview.postMessage({ type: 'state', connection: conn });
  
  // В settings.html
  window.addEventListener('message', event => {
    const msg = event.data; // Получение сообщения
  });
  ```

### State Management

- **Конфигурации подключений**: Управляются через `ConnectionManager`
  ```typescript
  // Получение конфигурации
  const connection = await connectionManager.getConnection(folder);
  
  // Сохранение конфигурации
  await connectionManager.saveConnection(folder, config);
  
  // Удаление конфигурации
  await connectionManager.removeConnection(folder);
  ```
- **Кэширование**: `ConnectionManager` использует `Map` для кэширования конфигураций в памяти
- **Хранение данных**: Используется `vscode.ExtensionContext.secrets` для безопасного хранения конфигураций

### Работа с API

- **Подключение к БД**: Через `DatabaseContextGenerator`
  ```typescript
  const generator = new DatabaseContextGenerator(config);
  const schema = await generator.loadSchema();
  ```
- **Генерация контекста**:
  ```typescript
  const markdown = await generator.generateMarkdown();
  ```
- **Импорт/экспорт .env**:
  ```typescript
  // Импорт
  const config = await connectionManager.importFromEnv(folder, envContent);
  
  // Экспорт
  const envString = await connectionManager.exportToEnv(folder);
  ```

### Типичный процесс добавления новой фичи

1. Определить необходимые типы в `src/types.ts`
2. Реализовать основную логику в соответствующем модуле
3. Добавить команду в `src/extension.ts` при необходимости
4. Обновить UI в `media/settings.html` если требуется
5. Реализовать взаимодействие между компонентами
6. Протестировать новую функциональность